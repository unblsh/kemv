{% extends "base.html" %}

{% block title %}Operational Dashboard - Online Retail{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Operational Dashboard</h2>
        <p class="text-muted">Daily Operations Overview</p>
    </div>
</div>

{% if no_data %}
<div class="alert alert-info" role="alert">
    <h4 class="alert-heading">No Data Available</h4>
    <p>There are no invoices in the database for the selected date. Please try a different date or check back later.</p>
</div>
{% else %}
<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Date Filter</h5>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dateMode" id="todayRadio" value="today" {% if date_mode == 'today' %}checked{% endif %}>
                    <label class="form-check-label" for="todayRadio">Today</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dateMode" id="customRadio" value="custom" {% if date_mode == 'custom' %}checked{% endif %}>
                    <label class="form-check-label" for="customRadio">Custom Date</label>
                </div>
                <input type="date" class="form-control mt-2" id="customDate" value="{{ current_date }}" {% if date_mode == 'today' %}disabled{% endif %}>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Country Filter</h5>
                <select class="form-select" id="countryFilter">
                    <option value="">All Countries</option>
                    {% for country in countries %}
                    <option value="{{ country }}" {% if country == selected_country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Today's Invoices</h5>
                <h2 class="display-4" id="orderCount">{{ daily_metrics.order_count }}</h2>
                <p class="card-text text-white-50">As of {{ current_date }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Today's Sales</h5>
                <h2 class="display-4" id="totalSales">${{ '%.2f'|format(daily_metrics.total_sales) }}</h2>
                <p class="card-text text-white-50">Total revenue for today</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Average Invoice Value</h5>
                <h2 class="display-4" id="avgOrderValue">${{ '%.2f'|format(daily_metrics.average_order_value) }}</h2>
                <p class="card-text text-white-50">Per invoice average</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Table -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Invoice Distribution by Country</h5>
                {% if status_distribution %}
                <canvas id="orderStatusChart"></canvas>
                {% else %}
                <div class="alert alert-info">No invoice distribution data available for the selected date.</div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Recent Invoices</h5>
                {% if recent_orders %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Invoice No</th>
                                <th>Customer</th>
                                <th>Country</th>
                                <th>Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recentInvoicesTableBody">
                            {% for invoice in recent_orders %}
                            <tr>
                                <td>{{ invoice.invoice_no }}</td>
                                <td>{{ invoice.customer_name }}</td>
                                <td>{{ invoice.country }}</td>
                                <td>{{ invoice.invoice_date }}</td>
                                <td>${{ '%.2f'|format(invoice.total_amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No recent invoices available for the selected date.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard2.js') }}"></script>
{% autoescape false %}
<script type="text/javascript">
window.dashboard2Initial = {
    daily_metrics: {{ daily_metrics|tojson }},
    status_distribution: {{ status_distribution|tojson }},
    recent_orders: {{ recent_orders|tojson }},
    countries: {{ countries|tojson }},
    selected_country: {{ selected_country|tojson }},
    current_date: {{ current_date|tojson }},
    date_mode: {{ date_mode|tojson }}
};
</script>
{% endautoescape %}
{% endblock %} 